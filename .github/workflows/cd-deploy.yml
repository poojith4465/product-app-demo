- name: SSH deploy (git pull + compose build + up)
  uses: appleboy/ssh-action@v1.2.0
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ec2-user
    key: ${{ secrets.SSH_KEY }}
    port: 22
    script: |
      set -e

      sudo mkdir -p /opt/product-app
      sudo chown -R $USER:$USER /opt/product-app
      cd /opt/product-app

      if [ ! -d ".git" ]; then
        git clone https://github.com/${{ github.repository }}.git .
      fi

      git fetch --all
      git reset --hard origin/main

      # Ensure buildx exists and is new enough (will fail fast if not installed)
      sudo docker buildx version
      sudo docker compose version

      # Create/use builder (safe if it already exists)
      sudo docker buildx create --name default-builder --use >/dev/null 2>&1 || true
      sudo docker buildx inspect --bootstrap

      # Build & run
      sudo docker compose -f docker-compose.yml up -d --build --remove-orphans

      # Cleanup
      sudo docker image prune -f